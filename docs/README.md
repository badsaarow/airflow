# Airflow

## Step

. venv/bin/activate
airflow tasks list cdss_etl

```sql
select type, name, format, json_agg(ts order by ts asc) as ts, json_agg(val) as val
from track_per_caseid_type
where device_id = '130bc450-406b-11ed-8f01-cfef1303339c'
and case_id = '007832df11'
group by type, name, format, unit, srate;
```

```sql
CREATE EXTENSION postgres_fdw;

CREATE SERVER foreign_server
        FOREIGN DATA WRAPPER postgres_fdw
        OPTIONS (host '192.83.123.2', port '5432', dbname 'thingsboard');

CREATE USER MAPPING FOR postgres
        SERVER foreign_server
        OPTIONS (user 'postgres', password 'postgres');

IMPORT FOREIGN SCHEMA public;

IMPORT FOREIGN SCHEMA thingsboard
FROM SERVER foreign_server INTO public;

create table public.track_per_caseid_type
(
    case_id   varchar(10000000),
    start_ts  bigint,
    end_ts    bigint,
    device_id uuid,
    type      text,
    name      text,
    format    text,
    unit      text,
    srate     text,
    ts        bigint,
    val       json
);

alter table public.track_per_caseid_type
    owner to postgres;


INSERT INTO public.track_per_caseid_type (case_id, start_ts, end_ts, device_id, type, name, format, unit, srate, ts, val) VALUES ('5ce2a87b8e', 1665563275447, 1665566874409, '130bc450-406b-11ed-8f01-cfef1303339c', 'Bx50_ECG1', 'ECG1', 'wav', 'mV', '300', 1665565963401, '[-0.164,-0.205,-0.245,-0.272,-0.29,-0.298,-0.294,-0.288,-0.283,-0.28,-0.28,-0.279,-0.279,-0.277,-0.279,-0.279,-0.279,-0.28,-0.278,-0.276,-0.276,-0.274,-0.269,-0.268,-0.265,-0.265,-0.268,-0.271,-0.275,-0.279,-0.281,-0.28,-0.28,-0.278,-0.275,-0.275,-0.273,-0.271,-0.272,-0.272,-0.272,-0.273,-0.275,-0.276,-0.279,-0.279,-0.278,-0.28,-0.279,-0.277,-0.277,-0.275,-0.272,-0.271,-0.267,-0.264,-0.265,-0.267,-0.269,-0.272,-0.274,-0.274,-0.275,-0.273,-0.271,-0.271,-0.268,-0.263,-0.263,-0.261,-0.261,-0.263,-0.263,-0.265,-0.27,-0.272,-0.276,-0.28,-0.281,-0.281,-0.282,-0.281,-0.277,-0.274,-0.269,-0.265,-0.263,-0.263,-0.264,-0.268,-0.27,-0.272,-0.275,-0.274,-0.272,-0.271,-0.268,-0.265,-0.266,-0.265,-0.265,-0.266,-0.267,-0.267,-0.272,-0.274,-0.275,-0.277,-0.275,-0.271,-0.269,-0.267,-0.265,-0.267,-0.267,-0.267,-0.268,-0.269,-0.27,-0.273,-0.275,-0.276,-0.278,-0.276,-0.275,-0.275,-0.272,-0.266,-0.264,-0.259,-0.257,-0.259,-0.259,-0.259,-0.261,-0.259,-0.259,-0.263,-0.263,-0.265,-0.268,-0.266,-0.262,-0.259,-0.253,-0.25,-0.258,-0.268,-0.278,-0.284,-0.275,-0.253,-0.226,-0.192,-0.162,-0.139,-0.115,-0.091,-0.076,-0.065,-0.056,-0.057,-0.062,-0.071,-0.085,-0.097,-0.114,-0.139,-0.165,-0.197,-0.232,-0.257,-0.274,-0.283,-0.278,-0.274,-0.27,-0.266,-0.267,-0.268,-0.267,-0.267,-0.268,-0.267,-0.267,-0.267,-0.267,-0.265,-0.265,-0.263,-0.263,-0.265,-0.264,-0.263,-0.264,-0.267,-0.276,-0.312,-0.378,-0.458,-0.522,-0.506,-0.374,-0.102,0.296,0.773,1.196,1.488,1.595,1.491,1.19,0.755,0.293,-0.1,-0.356,-0.483,-0.482,-0.411,-0.325,-0.277,-0.256,-0.249,-0.249,-0.254,-0.262,-0.264,-0.265,-0.267,-0.267,-0.267,-0.267,-0.265,-0.26,-0.259,-0.256,-0.255,-0.256,-0.256,-0.256,-0.259,-0.261,-0.264,-0.267,-0.268,-0.265,-0.263,-0.259,-0.256,-0.256,-0.256,-0.255,-0.256,-0.255,-0.255,-0.266,-0.277,-0.286,-0.293,-0.281,-0.255,-0.223,-0.182,-0.14,-0.108,-0.078,-0.049,-0.027,0.0,0.021,0.042,0.064,0.087,0.105,0.123,0.143,0.157,0.17,0.179,0.187,0.19,0.192,0.187,0.186,0.182,0.176,0.17,0.162,0.147,0.133,0.117,0.099,0.085,0.066,0.044,0.024,0.002,-0.027,-0.051,-0.083,-0.121]');
INSERT INTO public.track_per_caseid_type (case_id, start_ts, end_ts, device_id, type, name, format, unit, srate, ts, val) VALUES ('5ce2a87b8e', 1665563275447, 1665566874409, '130bc450-406b-11ed-8f01-cfef1303339c', 'Bx50_PLETH', 'PLETH', 'wav', '%', '100', 1665565963401, '[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0]');

select * from track_per_caseid_type;

```
